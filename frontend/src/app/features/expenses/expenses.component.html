<!-- Page Header -->
<div class="page-header">
  <div class="page-header__text">
    <h1 class="page-title">Expenses</h1>
    <p class="page-subtitle">Track every transaction across your accounts</p>
  </div>
  <button class="btn btn--primary btn--add" (click)="openAddModal()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
      <line x1="12" y1="5" x2="12" y2="19"/>
      <line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
    Add Expense
  </button>
</div>

<!-- Summary Strip -->
<div class="summary-strip" *ngIf="expenses().length > 0">
  <div class="summary-card summary-card--spent">
    <div class="summary-card__icon">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="1" x2="12" y2="23"/>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
      </svg>
    </div>
    <div class="summary-card__content">
      <span class="summary-card__label">Total Spent</span>
      <span class="summary-card__value">{{ formatCurrency(totalExpenses()) }}</span>
    </div>
  </div>

  <div class="summary-card summary-card--returns">
    <div class="summary-card__icon">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="1 4 1 10 7 10"/>
        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
      </svg>
    </div>
    <div class="summary-card__content">
      <span class="summary-card__label">Returns</span>
      <span class="summary-card__value">{{ formatCurrency(totalReturns()) }}</span>
    </div>
  </div>

  <div class="summary-card summary-card--net">
    <div class="summary-card__icon">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
      </svg>
    </div>
    <div class="summary-card__content">
      <span class="summary-card__label">Net Spending</span>
      <span class="summary-card__value">{{ formatCurrency(netTotal()) }}</span>
    </div>
  </div>

  <div class="summary-card summary-card--count">
    <div class="summary-card__icon">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
        <line x1="16" y1="13" x2="8" y2="13"/>
        <line x1="16" y1="17" x2="8" y2="17"/>
      </svg>
    </div>
    <div class="summary-card__content">
      <span class="summary-card__label">Transactions</span>
      <span class="summary-card__value">{{ filteredExpenses().length }}</span>
    </div>
  </div>
</div>

<!-- Filters Bar -->
<div class="filters-bar" *ngIf="expenses().length > 0">
  <div class="filters-bar__row">
    <div class="filter-group">
      <label class="filter-label">Category</label>
      <select class="filter-select" [(ngModel)]="filterCategory">
        <option value="">All Categories</option>
        <ng-container *ngFor="let cat of categories()">
          <option [value]="cat.id">{{ cat.icon }} {{ cat.name }}</option>
        </ng-container>
      </select>
    </div>

    <div class="filter-group">
      <label class="filter-label">From</label>
      <input class="filter-input" type="date" [(ngModel)]="filterDateFrom" />
    </div>

    <div class="filter-group">
      <label class="filter-label">To</label>
      <input class="filter-input" type="date" [(ngModel)]="filterDateTo" />
    </div>

    <div class="filter-group filter-group--toggle">
      <label class="filter-toggle">
        <input type="checkbox" [(ngModel)]="filterReturnOnly" />
        <span>Returns only</span>
      </label>
    </div>

    <button class="btn btn--ghost" *ngIf="hasActiveFilters()" (click)="clearFilters()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
      Clear
    </button>
  </div>
</div>

<!-- Loading -->
<div class="state-message" *ngIf="loading()">
  <div class="spinner"></div>
  <p>Loading expenses…</p>
</div>

<!-- Error -->
<div class="state-message state-message--error" *ngIf="error() && !loading()">
  <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round">
    <circle cx="12" cy="12" r="10"/>
    <line x1="15" y1="9" x2="9" y2="15"/>
    <line x1="9" y1="9" x2="15" y2="15"/>
  </svg>
  <p>{{ error() }}</p>
  <button class="btn btn--secondary" (click)="loadAll()">Retry</button>
</div>

<!-- Empty State -->
<div class="state-message state-message--empty" *ngIf="!loading() && !error() && expenses().length === 0">
  <div class="empty-icon">
    <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <rect x="2" y="3" width="20" height="18" rx="3"/>
      <line x1="8" y1="9" x2="16" y2="9"/>
      <line x1="8" y1="13" x2="13" y2="13"/>
      <line x1="8" y1="17" x2="11" y2="17"/>
    </svg>
  </div>
  <h3>No expenses yet</h3>
  <p>Start recording your first transaction</p>
  <button class="btn btn--primary" (click)="openAddModal()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
      <line x1="12" y1="5" x2="12" y2="19"/>
      <line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
    Record First Expense
  </button>
</div>

<!-- No filter results -->
<div class="state-message state-message--empty" *ngIf="!loading() && !error() && expenses().length > 0 && filteredExpenses().length === 0">
  <h3>No matching expenses</h3>
  <p>Try adjusting your filters</p>
  <button class="btn btn--secondary" (click)="clearFilters()">Clear Filters</button>
</div>

<!-- Expenses List -->
<div class="expenses-list" *ngIf="!loading() && !error() && filteredExpenses().length > 0">
  <ng-container *ngFor="let exp of filteredExpenses(); let i = index">
    <div
      class="expense-row"
      [class.expense-row--return]="exp.isReturn"
      [style.animation-delay]="i * 40 + 'ms'"
    >
      <!-- Category Icon -->
      <div
        class="expense-row__icon"
        [style.background]="getCategoryColor(exp.categoryId) + '18'"
      >
        {{ getCategoryIcon(exp.categoryId) }}
      </div>

      <!-- Info -->
      <div class="expense-row__info">
        <div class="expense-row__top">
          <span class="expense-row__desc">{{ exp.description || 'No description' }}</span>
          <span
            class="expense-row__cat-badge"
            [style.background]="(exp.categoryColor || getCategoryColor(exp.categoryId)) + '18'"
            [style.color]="exp.categoryColor || getCategoryColor(exp.categoryId)"
          >
            {{ exp.categoryName }}
          </span>
          <span class="expense-row__return-badge" *ngIf="exp.isReturn">Return</span>
        </div>
        <div class="expense-row__bottom">
          <span class="expense-row__date">{{ formatDate(exp.date) }}</span>
          <span class="expense-row__dot">·</span>
          <span class="expense-row__account">{{ exp.accountName }}</span>
        </div>
      </div>

      <!-- Amount -->
      <div class="expense-row__amount" [class.expense-row__amount--return]="exp.isReturn">
        {{ exp.isReturn ? '+' : '-' }}{{ formatCurrency(exp.amount) }}
      </div>

      <!-- Actions -->
      <div class="expense-row__actions">
        <button class="icon-btn" title="Edit" (click)="openEditModal(exp)">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
        </button>
        <button class="icon-btn icon-btn--danger" title="Delete" (click)="openDeleteConfirm(exp)">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
        </button>
      </div>
    </div>
  </ng-container>
</div>

<!-- Add/Edit Modal -->
<div class="modal-backdrop" *ngIf="showModal()" (click)="onBackdropClick($event)">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal__header">
      <h2>{{ editingExpense() ? 'Edit Expense' : 'New Expense' }}</h2>
      <button class="icon-btn" (click)="closeModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <div class="modal__body">
      <!-- Amount -->
      <div class="form-group">
        <label class="form-label" for="expAmount">Amount (PLN)</label>
        <input
          class="form-input form-input--money"
          id="expAmount"
          type="number"
          min="0.01"
          step="0.01"
          placeholder="0.00"
          [(ngModel)]="formAmount"
          autofocus
        />
      </div>

      <!-- Description -->
      <div class="form-group">
        <label class="form-label" for="expDesc">Description</label>
        <input
          class="form-input"
          id="expDesc"
          type="text"
          placeholder="e.g. Weekly groceries, Netflix…"
          [(ngModel)]="formDescription"
        />
      </div>

      <!-- Date -->
      <div class="form-group">
        <label class="form-label" for="expDate">Date</label>
        <input
          class="form-input"
          id="expDate"
          type="date"
          [(ngModel)]="formDate"
        />
      </div>

      <!-- Row: Account + Category -->
      <div class="form-row">
        <div class="form-group form-group--half">
          <label class="form-label" for="expAccount">Account</label>
          <select class="form-select" id="expAccount" [(ngModel)]="formAccountId">
            <ng-container *ngFor="let acc of accounts()">
              <option [ngValue]="acc.id">{{ acc.name }}</option>
            </ng-container>
          </select>
        </div>
        <div class="form-group form-group--half">
          <label class="form-label" for="expCategory">Category</label>
          <select class="form-select" id="expCategory" [(ngModel)]="formCategoryId">
            <ng-container *ngFor="let cat of categories()">
              <option [ngValue]="cat.id">{{ cat.icon }} {{ cat.name }}</option>
            </ng-container>
          </select>
        </div>
      </div>

      <!-- Is Return toggle -->
      <div class="form-group">
        <label class="toggle-row">
          <input type="checkbox" [(ngModel)]="formIsReturn" />
          <span class="toggle-label">This is a return / refund</span>
        </label>
      </div>

      <div class="form-error" *ngIf="formError">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        {{ formError }}
      </div>
    </div>

    <div class="modal__footer">
      <button class="btn btn--secondary" (click)="closeModal()" [disabled]="saving()">Cancel</button>
      <button class="btn btn--primary" (click)="saveExpense()" [disabled]="saving()">
        <div class="spinner spinner--sm" *ngIf="saving()"></div>
        {{ saving() ? 'Saving…' : (editingExpense() ? 'Update' : 'Add Expense') }}
      </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation -->
<div class="modal-backdrop" *ngIf="showDeleteConfirm()" (click)="onDeleteBackdropClick($event)">
  <div class="modal modal--sm" role="dialog" aria-modal="true">
    <div class="modal__header modal__header--danger">
      <div class="modal__danger-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
      </div>
      <h2>Delete Expense</h2>
    </div>
    <div class="modal__body">
      <p class="delete-message">
        Are you sure you want to delete
        <strong>{{ deletingExpense()?.description || 'this expense' }}</strong>
        ({{ formatCurrency(deletingExpense()?.amount || 0) }})?
        The account balance will be adjusted. This action cannot be undone.
      </p>
    </div>
    <div class="modal__footer">
      <button class="btn btn--secondary" (click)="closeDeleteConfirm()" [disabled]="deleting()">Cancel</button>
      <button class="btn btn--danger" (click)="confirmDelete()" [disabled]="deleting()">
        <div class="spinner spinner--sm" *ngIf="deleting()"></div>
        {{ deleting() ? 'Deleting…' : 'Delete Expense' }}
      </button>
    </div>
  </div>
</div>